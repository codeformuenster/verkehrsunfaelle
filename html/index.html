<html lang="de-de" dir="ltr">

  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>CodeForMuenster.org</title>
      <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
      <link rel="apple-touch-icon-precomposed" href="images/apple-touch-icon.png">
      <link rel="stylesheet" href="/css/c4m.css">
      <link rel="stylesheet" href="/uikit/css/uikit.gradient.min.css">
      <link rel="stylesheet" href="/uikit/css/tooltip.gradient.min.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
      <script src="/uikit/js/uikit.min.js"></script>
      <script src="/uikit/js/tooltip.js"></script>
      <script src="/js/util.js"></script>

                  <link rel="stylesheet" href="/lib/leaflet.css" />

                  <script src="/lib/leaflet.js"></script>

                  <script src="/lib/Leaflet.Editable.js"></script>

      <style>
      .layerClick {
        margin:2px 0;
        padding:3px 20px;
        background-color:#ddd;
        border-radius:5px;
        cursor:pointer;
      }

      #unfall_detail_link {
        display: none;
      }
      </style>
  </head>

  <body>
      <div class="uk-container uk-container-center uk-margin-top uk-margin-large-bottom">

          <nav class="uk-navbar uk-margin-large-bottom">
              <a class="uk-navbar-brand uk-hidden-small" href="/index.html"><img style="height:40px" src="http://codeformuenster.org/img/cfm_logo.png" /></a>
              <ul class="uk-navbar-nav uk-hidden-small">
                  <li>
                      <a href="/index.html">Startseite</a>
                  </li>
                  <li>
                      <a href="/index.html#projekte"> Projekte</a>
                  </li>
                  <li>
                      <a target="_blank" href="http://www.meetup.com/OK-Lab-Munster/"><i class="uk-icon-external-link"></i> Nächstes Treffen (meetup.com)</a>
                  </li>
                  <li>
                      <a target="_blank" href="https://github.com/codeformuenster/"><i class="uk-icon-external-link"></i> Quellcode auf Github</a>
                  </li>
              </ul>
              <a href="#offcanvas" class="uk-navbar-toggle uk-visible-small" data-uk-offcanvas></a>
              <div class="uk-navbar-brand uk-navbar-center uk-visible-small">Code For Münster</div>
          </nav>

        <h1 class="uk-text-center">Verkehrsunfälle in Münster</h1>

        <div  class="uk-grid"  data-uk-grid-margin>
          <div class="uk-width-medium-1-1">
            <p>Dank einer Anfrage bei <a href="https://fragdenstaat.de" target="_blank">Frag den Staat</a> sind wir an Rohdaten der Verkehsunfälle der Jahre 2007 bis 2014 gekommen. Nach mehreren Versuchen ist es uns gelungen, die zwischen den Jahren unterschiedlichen Spaltennamen und Formate in eine Datenbank zu laden um sie zu visualisieren und einfach zugänglich zu machen. Bedauerlicherweise werden die Orte der Verkehrsunfälle in einem für Geocoder unverständlichem Format aufgenommen (z.B.: "Kappenberger Damm, Höhe Kriegerweg"). Wir haben es uns nun zur Aufgabe gemacht alle Unfälle durchzugehen und den korrekten Ort einzupflegen.</p>
            <p>Diese Webseite ermöglicht es jedem bei diesem Prozess zu helfen! Es wird jeweils ein Unfall mit der Ortsbeschreibung der Polizei und dem ungefähren Ort angezeigt. Der Marker auf der Karte lässt sich dann an den korrekten Ort verschieben und dann mit dem "Speichern" Button abspeichern. Gemeinsam kann so der Datenbestand validiert, vervollständigt und verbessert werden!</p>
          </div>

          <div class="uk-width-medium-3-5">
            <div id="map" style="height:500px">
            </div>
          </div>

          <div class="uk-width-medium-2-5">
            <div class="uk-panel uk-panel-box uk-margin-bottom">
              <h2 class="uk-panel-title">Ort laut Polizei:</h2>
              Ort: <span id="vu_ort"></span><br />
              Höhe: <span id="vu_hoehe"></span>
              <a href="" id="unfall_detail_link">Alle Details anzeigen</a>
            </div>
            <div class="uk-container-center">
              <button id="refresh" class="uk-button uk-button-large uk-width-1-1 uk-margin-small-bottom" type="button">Neuer Unfall</button>
              <button id="saveButton" class="uk-button uk-button-large uk-button-success uk-width-1-1" type="button">Speichern</button>
            </div>
          <div>

        </div>

        <hr class="uk-grid-divider wider">

    </div>
        </div>


        <!-- mobile navigation -->
        <div id="offcanvas" class="uk-offcanvas">
            <div class="uk-offcanvas-bar">
                <ul class="uk-nav uk-nav-offcanvas">
                  <li class="uk-active">
                      <a href="/index.html">CodeForMuenster.Org</a>
                  </li>
                    <li>
                        <a href="/index.html"> Startseite </a>

                    </li>
                    <li>
                        <a target="_blank" href="http://www.meetup.com/OK-Lab-Munster/"><i class="uk-icon-external-link"></i> Nächstes Treffen (meetup.com)</a>

                    </li>
                    <li>
                        <a target="_blank" href="https://github.com/codeformuenster/"><i class="uk-icon-external-link"></i> Quellcode auf Github</a>

                    </li>
                </ul>
            </div>
        </div>

        <!-- github ribbon -->
        <a href="https://github.com/codeformuenster"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>


        <div class="tm-footer">
            <div class="uk-container uk-container-center uk-text-center">

                <ul class="uk-subnav uk-subnav-line uk-flex-center">
                    <li><a href="https://github.com/codeformuenster">GitHub</a></li>
                    <li><a href="https://github.com/codeformuenster/codeformuenster/issues">Issues</a></li>
                    <li><a href="https://github.com/orgs/codeformuenster/people">Komplette Mitgliederliste</a></li>
                    <li><a href="https://twitter.com/codeformuenster">Twitter</a></li>
                    <li><a href="/impressum/index.html">Impressum</a></li>
                </ul>

                <div class="uk-panel">
                  <p> <!-- some text could be here --></p>
                    <a href="http://codeformuenster.org"><img src="http://codeformuenster.org/img/cfm_logo.png"></a>
                </div>

            </div>
        </div>
        <script>
          (function() {
              // generate map
              var map = L.map('map', {editable: true}).setView([51.96, 7.62], 13);

              L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                  attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
              }).addTo(map);

              var unfallMarker;
              var span_vu_ort = document.getElementById("vu_ort");
              var span_vu_hoehe = document.getElementById("vu_hoehe");
              var unfall_detail_link = document.getElementById("unfall_detail_link");

              function ajaxFail () {
                UIkit.modal.alert("Fehler beim laden oder speichern. Dies sollte eigentlich nicht passieren. Bitte melde dich bei <a href=\"https://twitter.com/ubergesundheit\">@ubergesundheit auf Twitter</a>");
                span_vu_ort.textContent = "Fehler :(";
                span_vu_hoehe.textContent = "Fehler :(";
                $("#saveButton").removeProp("disabled");
              }

              // load remote json data
              function loadUnfallJson() {

                //

                span_vu_ort.textContent = "wird";
                span_vu_hoehe.textContent = "geladen...";

                var path = "/random_unfall_as_geojson";

                var unfall_id = getParameterValue("unfall_id");
                if (unfall_id !== "") {
                  path = "/unfaelle_as_geojson?properties-%3E%3Eunfall_id=eq." + unfall_id;
                }

                $.ajax(baseUrl + path, {
                  dataType: "json",
                  headers: {
                    "Prefer": "plurality=singular"
                  }
                })
                .done(function( data ) {
                    console.log("got data", data);

                    var latLon = data.geometry.coordinates;
                    console.log(latLon);
                    map.setView([latLon[1], latLon[0]], 17);

                    span_vu_ort.textContent = data.properties.vu_ort;
                    span_vu_hoehe.textContent = data.properties.vu_hoehe;

                    unfallMarker = L.marker([latLon[1], latLon[0]]);
                    unfallMarker._unfallProperties = data.properties;
                    map.addLayer(unfallMarker);
                    unfallMarker.enableEdit();
                    $("#saveButton").prop("disabled", false);

                    unfall_detail_link.href = "unfall.html?unfall_id=" + data.properties.unfall_id;
                    unfall_detail_link.style.display = "block";

                    history.pushState({}, document.title, "?unfall_id=" + data.properties.unfall_id);
                })
                .fail(ajaxFail);
              }
              function saveUnfall () {
                var latlng = unfallMarker.getLatLng()
                var unfall_id = unfallMarker._unfallProperties.unfall_id;
                $.ajax({
                  type: "POST",
                  url: baseUrl + "/unfaelle",
                  data: JSON.stringify({ unfall_id: unfall_id, lat: latlng.lat, lon: latlng.lng }),
                  contentType: "application/json"
                })
                .done(function () {
                  UIkit.modal.confirm("Unfall erfolgreich gespeichert!", function(){
                  window.location.search = "";
                  //window.location.reload(true);
                  }, {labels: {'Ok': 'Nächster Unfall', 'Cancel': 'nicht weitermachen'}});
                })
                .fail(ajaxFail)
              }
              // initial json load
              loadUnfallJson();

              $("#saveButton").click(function () {
                $("#saveButton").prop("disabled", true);
                saveUnfall();
              });

              $("#refresh").click(function () {
                  //window.location.reload(true);
                  window.location.search = "";
              });
            })();
        </script>
    </body>

</html>
